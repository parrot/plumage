# Copyright (C) 2009, Parrot Foundation.

# Command aliases and portability fixes
PERL        = @perl@
RM_F        = @rm_f@
CP          = @cp@
CHMOD       = @chmod@

O           = @o@
EXE         = @exe@

PARROT_BIN  = @bindir@
PARROT_LIB  = @libdir@@versiondir@

PARROT      = $(PARROT_BIN)/parrot
PBC_TO_EXE  = $(PARROT_BIN)/pbc_to_exe
PARROT_NQP  = $(PARROT_BIN)/parrot_nqp
NQP_PBC     = $(PARROT_LIB)/languages/nqp/nqp.pbc

# The default target
all: plumage

# List all user-visible targest
help:
	@echo ""
	@echo "The following targets are available:"
	@echo ""
	@echo "  all:         Generate plumage executable (default target)"
	@echo "  clean:       Clean generated files"
	@echo "  help:        Print this help message"
	@echo ""

plumage$(EXE): src/plumage$(EXE)
	$(CP) src/plumage$(EXE) plumage$(EXE)
	$(CHMOD) 0755 plumage$(EXE)

src/plumage$(EXE): src/plumage.pbc src/lib/Glue.pbc
	$(PBC_TO_EXE) src/plumage.pbc

src/plumage.pbc: src/plumage.pir
	$(PARROT) -o src/plumage.pbc src/plumage.pir

src/plumage.pir: src/plumage.nqp
	$(PARROT) $(NQP_PBC) --target=pir -o src/plumage.pir src/plumage.nqp

src/lib/Glue.pbc: src/lib/Glue.pir
	$(PARROT) -o src/lib/Glue.pbc src/lib/Glue.pir


# Convenience
realclean: clean

clean:
	$(RM_F) "*~" "src/lib/*.pbc" "src/*.pbc" "src/*$(O)" "src/*.c" \
	        src/plumage.pir src/plumage$(EXE) plumage$(EXE) Makefile

test:
	$(PARROT_NQP) t/harness t/*.t

# Local variables:
#   mode: makefile
# End:
# vim: ft=make:
